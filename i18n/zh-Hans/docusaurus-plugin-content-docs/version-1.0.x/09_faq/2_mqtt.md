---
sidebar_position: 2
---

# MQTT 的使用

## 为什么物联网要使用MQTT协议？对比HTTP协议有什么优势？

物联网设备通常需要发送和接收小型的数据包，如传感器读数、设备状态等等。MQTT (Message Queuing Telemetry Transport)是一个基于发布/订阅模式的轻量级通信协议，专门为低带宽和不可靠网络环境设计，非常适合于物联网应用。

相对于HTTP协议，MQTT具有以下优势：

- 更轻量级：对比HTTP的庞大协议头，MQTT协议非常精简，消息体比HTTP更小，可以减少网络传输负担。
- 更低功耗：MQTT协议的低功耗特性使其非常适合于物联网设备，例如传感器、智能家居等设备，这些设备通常拥有非常有限的电池寿命。
- 更高效率：MQTT协议采用了推送的方式来传递消息，可以大大减少客户端和服务器之间的通信开销。同时，MQTT协议的QoS机制也可以确保消息的可靠传输，使得通信更加稳定和高效。
- 更易扩展：MQTT协议采用了主题（Topic）的发布/订阅模式，使得系统的可扩展性更高，可以快速适应新的设备和应用场景。相比之下，HTTP协议需要在服务器端部署RESTful接口，限制了系统的扩展性。

总之，MQTT协议适用于需要低功耗、小型数据包和高效传输的物联网设备，HTTP协议则适用于需要大量数据传输和更复杂请求响应的应用场景。

## 如何应对客户端与服务端的连接不正常断开？
考虑到物联网设备经常工作在不稳定的网络环境，MQTT协议以及常见的开源客户端实现都对连接意外中断有相应设计和处理。

请为客户端设置断线自动重连，如果客户端还负责订阅主题的话，还需要设置重连后自动重新订阅。

如果不希望丢失断线期间的重要消息，可以将订阅设置中的cleanSession设置为False。但请慎重的使用这一设置，并合理设置topicfilter，将重要消息与大量的普通消息分开，仅为最必要的消息订阅使用。大量不合理的使用cleanSession False设置会带来严重的性能压力和更大的消息丢失风险。

如果出现不符合预期的高频率意外断连，请检查客户端到服务端的网络链路。

## 为什么会出现消息丢失，发送成功的消息订阅端没有收到？
消息丢失存在多种可能：

- 网络不稳定导致丢包：依物联网设备的具体网络环境可能出现不同程度的丢包。如果需要保证消息到达，可以使用 qos 1 的设置来发送和订阅消息。这一设置也会消耗更多的性能。
- 订阅端掉线：如果一个topic没有被订阅，那么消息会被直接丢弃。
- 单连接收发消息超限：默认配置下单个客户端拥有每秒200条消息、512MB带宽的限制。如果是发送端，超出这个限制的消息会发送失败，而如果是订阅端超出，cleanSession True设置下的消息会被丢弃。
- 发送消息的频率太高导致下游溢出：cleanSession True下的订阅端、规则引擎下游溢出，cleanSession False下的inbox消息缓存溢出等。可以合理拆分topic来降低每个订阅端收到的消息频率，或是使用共享订阅。
- 资源不足：若部署 BifroMQ 服务的内存或CPU资源，不足以支持业务规模，也可能造成此情况，需要评估业务规模并合理扩容。

## 订阅端收到的消息顺序和发送顺序一致吗？
依据MQTT协议，我们保证了消息顺序。

特别的，在QoS 0下，单一发送端发送的消息一定是先发送的先到达。在QoS 1下，因为存在重发消息的情况，可能存在偶尔的乱序，但重发消息后，按照协议，会按顺序将重发消息后面的消息再按序发送，保证客户收到的消息序列中，至少存在一条子序列是完全有序的。

# 为什么会重复出现连接 - 断开 - 重连 - 再断开的情况？
一般是因为互踢。ClientID必须唯一，否则会断开前面已经连接的冲突设备。如果这两个设备都设置了断线自动重连，那么就会反复互踢，出现此问题的情况。
