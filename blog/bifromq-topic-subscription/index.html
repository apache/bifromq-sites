<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">BifroMQ&#x27;s Topic Subscription Mechanism | Apache BifroMQ (Incubating) - Open source MQTT Broker</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://bifromq.apache.org/blog/bifromq-topic-subscription/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="BifroMQ&#x27;s Topic Subscription Mechanism | Apache BifroMQ (Incubating) - Open source MQTT Broker"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-12-04T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/popduke"><meta data-rh="true" property="article:tag" content="BifroMQ,MQTT,Topic,TopicFilter,Subscription,Serverless,Multi-Tenant"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://bifromq.apache.org/blog/bifromq-topic-subscription/"><link data-rh="true" rel="alternate" href="https://bifromq.apache.org/blog/bifromq-topic-subscription/" hreflang="en"><link data-rh="true" rel="alternate" href="https://bifromq.apache.org/blog/bifromq-topic-subscription/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://bifromq.apache.org/blog/bifromq-topic-subscription","mainEntityOfPage":"https://bifromq.apache.org/blog/bifromq-topic-subscription","url":"https://bifromq.apache.org/blog/bifromq-topic-subscription","headline":"BifroMQ's Topic Subscription Mechanism","name":"BifroMQ's Topic Subscription Mechanism","description":"Introduction","datePublished":"2023-12-04T00:00:00.000Z","author":{"@type":"Person","name":"Yonny(Yu) Hao","url":"https://github.com/popduke","image":"https://github.com/popduke.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://bifromq.apache.org/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache BifroMQ (Incubating) - Open source MQTT Broker RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache BifroMQ (Incubating) - Open source MQTT Broker Atom Feed"><link rel="stylesheet" href="/assets/css/styles.e2175d5d.css">
<script src="/assets/js/runtime~main.09990170.js" defer="defer"></script>
<script src="/assets/js/main.ccf42c75.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><link rel="preload" as="image" href="/img/logo_dark.svg"><link rel="preload" as="image" href="https://github.com/popduke.png"><link rel="preload" as="image" href="/assets/images/MQTT_Topic_TopicFilter-e13feb2f5121c422b96acf1681688ff4.png"><link rel="preload" as="image" href="/assets/images/TopicExpansionSet-daa2a2c9dd755e78b8853e8ebe8f0a37.png"><link rel="preload" as="image" href="/assets/images/OnePass-f2c1ed548f73798a4d965c4916867867.png"><link rel="preload" as="image" href="/assets/images/DistService-cd9ddb48038f1c80474871bcfe44692b.png"><link rel="preload" as="image" href="/img/apache-incubator.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_cCsT" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="BifroMQ Logo" class="bifromq-navbar-logo-class themedComponent_kh6W themedComponent--light_h03h"><img src="/img/logo_dark.svg" alt="BifroMQ Logo" class="bifromq-navbar-logo-class themedComponent_kh6W themedComponent--dark_QNPN"></div><b class="navbar__title text--truncate">Apache BifroMQ (Incubating)</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/get_started/intro/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog/">Blog</a><a class="navbar__item navbar__link" href="/community/">Community</a><a class="navbar__item navbar__link" href="/docs/get_started/download/intro/">Download</a><a class="navbar__item navbar__link" href="/docs/get_started/faq/">FAQ</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/get_started/intro/">Next (Incubating)</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/get_started/intro/">Next (Incubating)</a></li><li><a class="dropdown__link" href="/docs/3.3.x/get_started/intro/">3.3.x</a></li><li><a class="dropdown__link" href="/docs/3.2.x/get_started/intro/">3.2.x</a></li><li><a class="dropdown__link" href="/docs/3.1.x/get_started/intro/">3.1.x</a></li><li><a class="dropdown__link" href="/docs/3.0.x/get_started/intro/">3.0.x</a></li><li><a class="dropdown__link" href="/docs/2.1.x/Readme/">2.1.x</a></li><li><a class="dropdown__link" href="/docs/2.0.0/Readme/">2.0.0</a></li><li><a class="dropdown__link" href="/docs/1.0.x/Readme/">1.0.x</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li><li><a href="https://www.apache.org/foundation/policies/conduct.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Code of Conduct</a></li></ul></div><a href="https://github.com/apache/bifromq" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_mVhP colorModeToggle_uW4C"><button class="clean-btn toggleButton_IMMl toggleButtonDisabled_LuC_" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_X8N1 lightToggleIcon_AJW3"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_X8N1 darkToggleIcon_JatO"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_X8N1 systemToggleIcon__uuk"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_AGV4"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_tdfK"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_dtOB thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_QI0f margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_JaZ8">2024</h3><ul class="sidebarItemList_sf3w clean-list"><li class="sidebarItem_MlaL"><a class="sidebarItemLink_PdtZ" href="/blog/bifromq-version-3/">BifroMQ 3.0.0 Beta: Enhanced Messaging with MQTT 5.0</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_JaZ8">2023</h3><ul class="sidebarItemList_sf3w clean-list"><li class="sidebarItem_MlaL"><a aria-current="page" class="sidebarItemLink_PdtZ sidebarItemLinkActive_J7Co" href="/blog/bifromq-topic-subscription/">BifroMQ&#x27;s Topic Subscription Mechanism</a></li><li class="sidebarItem_MlaL"><a class="sidebarItemLink_PdtZ" href="/blog/bifromq-high-availibility/">BifroMQ: Unveiling the Technology for Building Efficient and Available Clusters</a></li><li class="sidebarItem_MlaL"><a class="sidebarItemLink_PdtZ" href="/blog/bifromq-standardcluster/">BifroMQ StandardCluster</a></li><li class="sidebarItem_MlaL"><a class="sidebarItemLink_PdtZ" href="/blog/bifromq-tech-architecture/">BifroMQ Technical Architecture Overview</a></li><li class="sidebarItem_MlaL"><a class="sidebarItemLink_PdtZ" href="/blog/AnyAuth and Integration with BifroMQ/">AnyAuth and Integration with BifroMQ</a></li><li class="sidebarItem_MlaL"><a class="sidebarItemLink_PdtZ" href="/blog/news-bifromq-opensource/">BifroMQ officially open source : high-performance multi-tenant MQTT Broker</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_LGXf">BifroMQ&#x27;s Topic Subscription Mechanism</h1><div class="container_o_qj margin-vert--md"><time datetime="2023-12-04T00:00:00.000Z">December 4, 2023</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_nbqI"><div class="avatar margin-bottom--sm"><a href="https://github.com/popduke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_QuNx" src="https://github.com/popduke.png" alt="Yonny(Yu) Hao"></a><div class="avatar__intro authorDetails_zi_r"><div class="avatar__name"><a href="https://github.com/popduke" target="_blank" rel="noopener noreferrer"><span class="authorName_J_rd">Yonny(Yu) Hao</span></a></div><div class="authorSocials_ZMMT"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><h2 class="anchor anchorWithStickyNavbar_u6yr" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>Since BifroMQ became open source, we have frequently received inquiries about its implementation details for Topic subscription matching. In the MQTT Pub/Sub mechanism, Topic subscription matching is undoubtedly one of the core functionalities. In BifroMQ, the management of subscription information and the processing of message Topic matching are handled by a dedicated service module called Dist Service (<strong>bifromq-dist</strong>). Given that BifroMQ is designed to support the construction of large-scale, multi-tenant Serverless systems, this critical component faces many complex challenges, particularly in the distributed processing of subscription information (TopicFilter) and the associated Topic matching algorithms. This article will delve into the design decision behind the BifroMQ Topic subscription matching scheme and its implementation in Dist Service.</p>
<h2 class="anchor anchorWithStickyNavbar_u6yr" id="mqtts-topic-and-topicfilter">MQTT&#x27;s Topic and TopicFilter<a href="#mqtts-topic-and-topicfilter" class="hash-link" aria-label="Direct link to MQTT&#x27;s Topic and TopicFilter" title="Direct link to MQTT&#x27;s Topic and TopicFilter">​</a></h2>
<p>In this section, we shall briefly revisit two fundamental concepts in MQTT related to Topic subscription and matching: <em>Topic</em> and <em>TopicFilter</em>. During the publication (Pub) process in MQTT, a <em>Topic</em> is used to identify the specific subject of a message. Conversely, during the subscription (Sub) process, a <em>TopicFilter</em> is employed to denote the intention to subscribe to a series of subjects. This article will distinctly differentiate these two concepts: <em>Topic</em> and <em>TopicFilter</em>.
Both <em>Topic</em> and <em>TopicFilter</em> are UTF-8 strings, akin to file directory paths, examples being “<code>/a/b/c</code>”, “<code>/a/b/c/</code>”, “<code>/+/b/c</code>”, and “<code>+/b/#</code>”. In these strings, “<code>/</code>” serves as the separator for each &#x27;directory&#x27; or <em>TopicLevel</em>. The primary difference between <em>TopicFilter</em> and <em>Topic</em> lies in the character set of the <em>TopicLevel</em>: <em>TopicFilter</em> permits the use of wildcard characters “<code>+</code>” and “<code>#</code>” as standalone <em>TopicLevel</em>s. These wildcards represent the logic for matching a range of topics. The “<code>+</code>” symbol is a single-level wildcard character (Single-level Wildcard Character), which can appear in any position (e.g., “<code>+</code>”, “<code>/+</code>”, “<code>+/+</code>”) and is used to match all <em>TopicLevel</em>s at that particular level. The “<code>#</code>” symbol, on the other hand, is a multi-level wildcard character (Multi-level Wildcard Character), and can only appear as the last TopicLevel (e.g., “<code>#</code>”, “<code>/#</code>”, “<code>+/+/#</code>”, “<code>+/#</code>”), used to match the specified level and all subsequent levels of TopicLevels.
<em>TopicFilter</em> matches <em>Topics</em> in a left-to-right sequence. Here are some examples from the MQTT specification to illustrate this point:
First, let&#x27;s consider the application of the single-level wildcard “<code>+</code>”. Suppose a client subscribes to “<code>sport/+/player1</code>”; it will receive messages published under the following Topic names:</p>
<ul>
<li>“<code>sport/tennis/player1</code>”</li>
<li>“<code>sport/badminton/player1</code>”</li>
<li>“<code>sport/golf/player1</code>”
However, it will not receive messages for “<code>sport/tennis/player2</code>” or “<code>sport/tennis/player1/ranking</code>”.
Similarly, if a client subscribes to “``+/tennis/player1`”, it will receive messages for:</li>
<li>“<code>sport/tennis/player1</code>”</li>
<li>“<code>world/tennis/player1</code>”
But it will not receive messages for “<code>sport/tennis/player2</code>” or “<code>sport/badminton/player1</code>”.
Next, let’s consider the multi-level wildcard “<code>#</code>”. For example, if a client subscribes to “<code>sport/tennis/player1/#</code>”, it will receive messages published under:</li>
<li>“<code>sport/tennis/player1</code>”</li>
<li>“<code>sport/tennis/player1/ranking</code>”</li>
<li>“<code>sport/tennis/player1/score/wimbledon</code>”</li>
</ul>
<p>Important points to note when using “<code>#</code>” include:</p>
<ul>
<li>“<code>sport/#</code>” will also match the singular “<code>sport</code>”, as “<code>#</code>” includes the parent level.</li>
<li>Subscribing to “<code>#</code>” alone will match all Topics and receive messages on all subjects.</li>
<li>“<code>sport/tennis/#</code>” is valid, while “<code>sport/tennis#</code>” and “<code>sport/tennis/#/ranking</code>” are not valid.</li>
</ul>
<p>These examples clearly demonstrate how <em>TopicFilter</em>s in MQTT can precisely and flexibly match specific ranges or types of messages.</p>
<p>It is noteworthy that the process of matching <em>TopicFilter</em> to a <em>Topic</em> can logically organize the <em>TopicFilter</em> into a Trie(or Tree) data structure, with the matching process being accomplished through tiered searching within the <em>TopicFilter</em> Trie. Special handling rules are applied when encountering special wildcard characters such as “<code>+</code>” and “<code>#</code>”. Below is a brief description of this process:</p>
<img src="/assets/images/MQTT_Topic_TopicFilter-e13feb2f5121c422b96acf1681688ff4.png" style="width:100%">
<p>Note:</p>
<ul>
<li>Each node within the <em>TopicFilter</em> Trie represents a string of a <em>TopicLevel</em>, which is different from the traditional String Prefix <a href="https://en.wikipedia.org/wiki/Trie" target="_blank" rel="noopener noreferrer">&#x27;Trie&#x27;</a> where each node denotes a single character.</li>
<li>When a <em>TopicFilter</em> does not contain any wildcard characters, its matching scope is limited to specific message topic. In such cases, a simple Map structure can be employed for subscription matching.</li>
<li>As per MQTT protocol, Topics starting with “$” are considered specially reserved system topics. These topics are not matched by wildcards and are specifically ignored during the search process.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_u6yr" id="scenarios-faced-by-bifromq">Scenarios Faced by BifroMQ<a href="#scenarios-faced-by-bifromq" class="hash-link" aria-label="Direct link to Scenarios Faced by BifroMQ" title="Direct link to Scenarios Faced by BifroMQ">​</a></h2>
<p>In this chapter, we will explore the specific scenarios and challenges BifroMQ faces when dealing with the <em>TopicFilter</em> Trie.
In typical implementations, the <em>TopicFilter</em> Trie is physically organized as a Trie (or Tree) structure in memory. In a distributed environment, each MQTT Broker node locally stores a complete replica of the <em>TopicFilter</em> Trie and maintains consistency among the nodes through inter-cluster communication. Given that read requests (i.e., matching operations) for the <em>TopicFilter</em> Trie are much more frequent than write requests (updates), traditional implementations allow the topic matching process to occur entirely locally, thus saving the round-trip time of remote access. However, this approach has two potential limitations:</p>
<ol>
<li>The size of the <em>TopicFilter</em> Trie is limited by the storage resources of a single node.</li>
<li>When adding new nodes, it is necessary to fully synchronize the <em>TopicFilter</em> Trie from other nodes, and the preparation time for the startup process is directly proportional to the size of the Trie.</li>
</ol>
<p>For most enterprise-level application scenarios, these potential issues are usually not a concern, as the scale of subscriptions is unlikely to reach the upper limit of a single node&#x27;s resources. However, in cloud service environments, especially in Multi-Tenant Serverless service scenarios that BifroMQ aims to support, this traditional approach is no longer suitable. The main reasons include:</p>
<ol>
<li>One common issue in multi-tenant scenarios is that the <em>TopicFilter</em> Trie becomes too large, exceeding the resource limits of a single node. This situation is especially prevalent in scenarios with a large number of IoT devices, such as SmartHome business, or due to improper subscription behavior and testing activities.</li>
<li>A large <em>TopicFilter</em> Trie usually indicates a business peak hours, necessitating rapid scaling so that new nodes can be quickly in service. However, fully synchronizing the Trie consumes preparation time during startup.</li>
</ol>
<p>Therefore, BifroMQ needs to explore solutions different from the classic approach to better adapt to the needs of building Multi-Tenant Serverless services. The core challenges of this new solution include:</p>
<ol>
<li>How to achieve the distribution of the <em>TopicFilter</em> Trie.</li>
<li>How to efficiently perform matching operations in a distributed environment.</li>
</ol>
<p>Addressing these challenges involves a completely new design of the storage mode and algorithms for the <em>TopicFilter</em> Trie, which we refer to as the &#x27;<strong>OnePass</strong>&#x27; method.</p>
<h2 class="anchor anchorWithStickyNavbar_u6yr" id="the-onepass-solution">The &quot;OnePass&quot; Solution<a href="#the-onepass-solution" class="hash-link" aria-label="Direct link to The &quot;OnePass&quot; Solution" title="Direct link to The &quot;OnePass&quot; Solution">​</a></h2>
<p>In an in-depth analysis of MQTT&#x27;s topic matching rules, we observe a significant characteristic: for any given <em>Topic</em>, all possible <em>TopicFilter</em>s that can match that <em>Topic</em> form a specific set. We refer to this set as the <strong><em>TopicFilter</em> ExpansionSet</strong>(or ExpansionSet briefly) for a particular <em>Topic</em>. The following figure illustrates this concept:</p>
<img src="/assets/images/TopicExpansionSet-daa2a2c9dd755e78b8853e8ebe8f0a37.png" style="width:100%">
<p>The ExpansionSet of particular <em>Topic</em> can also be represented using a Trie structure. In this structure, nodes at the same level are sorted in byte order. By performing an in-order traversal of the Trie of the ExpansionSet, we can obtain all possible <em>TopicFilter</em> strings arranged in lexicographical order. It&#x27;s important to note that during the comparison process, the delimiter &#x27;<code>/</code>&#x27; is not considered, or it can be replaced with a Unicode <code>null</code> character (&#x27;<code>\u0000</code>&#x27;). The size of the ExpansionSet (i.e., the number of possible TopicFilters) is related to the number of levels in the <em>Topic</em> and can be determined by the formula <code>F(x) = 6*2^x - 1</code>, with its space complexity being O(2^x), increasing geometrically with the number of levels.</p>
<p>However, for a specific <em>Topic</em>, the actual subscriptions that occur are just a small subset of its ExpansionSet. Therefore, we can store the subscriptions that actually occur within the system, using <em>TopicFilter</em> as a key prefix, in an ordered KV storage engine. In BifroMQ, this storage engine is implemented by <strong>base-kv</strong> -- The embedded distributed KV storage engine for building stateful services in BifroMQ. The storage mode of the <em>TopicFilter</em> Trie, formed by subscriptions, can be simplified as follows:</p>
<ul>
<li>key: <code>&lt;TenantId&gt;&lt;0x00&gt;&lt;TopicFilter&gt;&lt;SessionId&gt;</code></li>
<li>value: <code>&lt;MetadataAboutTheSubscription&gt;</code></li>
</ul>
<p>Using ordered KV storage, it is easy to achieve the distribution of the <em>TopicFilter</em> Trie logically formed by actual subscriptions. In BifroMQ, we utilize the sharding capability of base-kv to achieve this: subscriptions are distributed and balanced among nodes based on certain strategies, according to the load characteristics of topic subscription matching. During system scaling, new nodes only need to synchronize a portion of the shard replicas, eliminating the need to synchronize all subscription data, thereby meeting the requirements for rapid scaling.</p>
<p>After organizing subscription data into an ordered KV form, the next question is how to implement MQTT&#x27;s Topic matching logic. Specifically, when an MQTT Pub message is received, how can we find all the subscription records matching the message&#x27;s Topic through the read operation of KV storage? This process can be transformed into a mathematical Set problem: finding the intersection of the set formed by the <em>Topic</em>&#x27;s ExpansionSet and the set of <em>TopicFilter</em>s from the actual subscriptions in the current system. This is easily achievable!</p>
<img src="/assets/images/OnePass-f2c1ed548f73798a4d965c4916867867.png" style="width:100%">
<p>As shown in the figure, the left side displays the lexigraphical order ExpansionSet for the topic &quot;<code>a/b/c</code>&quot;, while the right side shows the current subscription relationships in the system, presented in an ordered KV storage format.</p>
<p>The core workflow of the matching algorithm involves sequentially scanning the subscription relationship KV on the right from top to bottom, and locating the position of the currently subscribed <em>TopicFilter</em> in the ExpansionSet on the left. If the <em>TopicFilter</em> exists in the left ExpansionSet, a match is considered found. If it does not exist, and assuming the next possible matching <em>TopicFilter</em> in the left ExpansionSet is <code>T</code>, the algorithm can skip all parts in the right-side ordered KV of subscription relationships that have a lexicographical order less than T, and then continue scanning.</p>
<p>This algorithm operates unidirectionally on both the left and right sets, so the completion of scanning in either set signifies the end of the algorithm.</p>
<p>From the perspective of space complexity, the left ExpansionSet essentially serves as an &#x27;index&#x27; and does not need to be actually expanded in memory. It only needs to identify the next possible <em>TopicFilter</em> that might appear in the right set according to the lexicographical order expansion rule, hence the space overhead of the left set can be neglected. The right set represents the actual existing subscription relationships in the current system, with its space complexity being <code>O(N)``, where </code>N` is the number of subscriptions.</p>
<p>The time complexity of the algorithm is related to the number of actual subscription relationships, with an upper limit of approximately <code>O(N*log(X))``, where </code>X` is the number of levels in the Topic. Of course, the worst-case scenario occurs when the right set includes every possible subscription for all Topics.</p>
<p>Since the algorithm only requires a single efficient scan of the subscription relationship KV storage data during execution, we have named this approach &#x27;<strong>OnePass</strong>&#x27;.</p>
<h2 class="anchor anchorWithStickyNavbar_u6yr" id="the-dist-service">The Dist Service<a href="#the-dist-service" class="hash-link" aria-label="Direct link to The Dist Service" title="Direct link to The Dist Service">​</a></h2>
<p>Dist Service (<strong>bifromq-dist</strong>) is a key sub-service within BifroMQ for handling subscriptions and message routing distribution, with the &#x27;OnePass&#x27; scheme forming the core of its sub-service architecture.</p>
<p>Dist Service comprises two server modules: DistServer and DistWorker. DistServer is a stateless RPC service module responsible for handling request scheduling; whereas DistWorker is a stateful module, incorporating a KV storage engine (base-kv), within which distributed storage of subscriptions data is implemented.</p>
<p>To reduce the latency costs associated with internal communication during message routing and distribution, Dist Service is designed to tightly couple data with computation. The term &#x27;data&#x27; here has a dual meaning: it refers both to the MQTT Pub messages themselves and to subscriptions data. &#x27;Computation,&#x27; on the other hand, pertains to the subscription matching and message distribution process. Dist Worker encapsulates the topic matching and distribution process of messages into the base-kv&#x27;s Range CoProcessor, ensuring that the matching and distribution processes occur locally where the subscription information is stored. Such a design effectively prevents additional data transmission from impacting the latency of messages within the BifroMQ system.</p>
<img src="/assets/images/DistService-cd9ddb48038f1c80474871bcfe44692b.png" style="width:100%">
<p>The above figure demonstrates the role played by DistService in handling MQTT Pub/Sub. To enhance the efficiency of subscription matching, Dist Worker has further optimized the &#x27;OnePass&#x27; scheme, notably through the introduction of a caching mechanism. Under this mechanism, for messages continuously published under the same <em>Topic</em>, only a single execution of the &#x27;OnePass&#x27; algorithm process is required. The results of the matching are cached for use in subsequent similar requests. This introduction of caching not only speeds up processing but also reduces the overhead of repeated computations and local IO. It is important to note, however, that the invalidation and update strategies associated with caching are complex and fall beyond the scope of this discussion, thus they are not elaborated in detail in this article.</p>
<h2 class="anchor anchorWithStickyNavbar_u6yr" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>Topic subscription matching is a core feature of the MQTT protocol, and its flexibility is a key factor in MQTT&#x27;s widespread application. However, the implementation solutions accumulated over the years by the community and industry have shown certain limitations in dealing with Multi-Tenant Serverless service scenarios. BifroMQ&#x27;s &#x27;OnePass&#x27; scheme, based on <a href="https://en.wikipedia.org/wiki/First_principle" target="_blank" rel="noopener noreferrer">First Principle</a> and starting from an architectural perspective, is an attempt to address this issue. We hope this approach can bring new inspiration to the community and drive the development and innovation of technology.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_kw4g padding--none margin-left--sm"><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/bifro-mq/">BifroMQ</a></li><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/mqtt/">MQTT</a></li><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/topic/">Topic</a></li><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/topic-filter/">TopicFilter</a></li><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/subscription/">Subscription</a></li><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/serverless/">Serverless</a></li><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/multi-tenant/">Multi-Tenant</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/apache/bifromq-sites/tree/master/website/blog" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_s6_v" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_SVwk"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/bifromq-version-3/"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">BifroMQ 3.0.0 Beta: Enhanced Messaging with MQTT 5.0</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/bifromq-high-availibility/"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">BifroMQ: Unveiling the Technology for Building Efficient and Available Clusters</div></a></nav></main><div class="col col--2"><div class="tableOfContents_D50z thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#mqtts-topic-and-topicfilter" class="table-of-contents__link toc-highlight">MQTT&#39;s Topic and TopicFilter</a></li><li><a href="#scenarios-faced-by-bifromq" class="table-of-contents__link toc-highlight">Scenarios Faced by BifroMQ</a></li><li><a href="#the-onepass-solution" class="table-of-contents__link toc-highlight">The &quot;OnePass&quot; Solution</a></li><li><a href="#the-dist-service" class="table-of-contents__link toc-highlight">The Dist Service</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" rel="noopener noreferrer" class="footerLogoLink_U0bA"><img src="/img/apache-incubator.svg" alt="Apache Incubator logo" class="footer__logo themedComponent_kh6W themedComponent--light_h03h" width="200"><img src="/img/apache-incubator.svg" alt="Apache Incubator logo" class="footer__logo themedComponent_kh6W themedComponent--dark_QNPN" width="200"></a></div><div class="footer__copyright"><div>
      <p>
        Apache BifroMQ is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
      </p>
      <p>
        Copyright © 2025 The Apache Software Foundation, Licensed under the Apache License, Version 2.0. <br>
        Apache, the names of Apache projects, and the feather logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries.
      </p>
      </div></div></div></div></footer></div>
</body>
</html>