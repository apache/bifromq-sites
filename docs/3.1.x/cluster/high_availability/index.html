<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-3.1.x docs-doc-page docs-doc-id-cluster/high_availability" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">High Availability | An Open Source Apache MQTT Broker | Apache BifroMQ (Incubating)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://bifromq.apache.org/docs/3.1.x/cluster/high_availability/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="3.1.x"><meta data-rh="true" name="docusaurus_tag" content="docs-default-3.1.x"><meta data-rh="true" name="docsearch:version" content="3.1.x"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-3.1.x"><meta data-rh="true" property="og:title" content="High Availability | An Open Source Apache MQTT Broker | Apache BifroMQ (Incubating)"><meta data-rh="true" name="description" content="Due to the decentralized cluster-building capability provided by the Gossip-based protocol (base-cluster) we offer, BifroMQ StandardCluster nodes do not require additional service discovery components to establish a cluster. This eliminates"><meta data-rh="true" property="og:description" content="Due to the decentralized cluster-building capability provided by the Gossip-based protocol (base-cluster) we offer, BifroMQ StandardCluster nodes do not require additional service discovery components to establish a cluster. This eliminates"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://bifromq.apache.org/docs/3.1.x/cluster/high_availability/"><link data-rh="true" rel="alternate" href="https://bifromq.apache.org/docs/3.1.x/cluster/high_availability/" hreflang="en"><link data-rh="true" rel="alternate" href="https://bifromq.apache.org/docs/3.1.x/cluster/high_availability/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"BifroMQ Cluster","item":"https://bifromq.apache.org/docs/3.1.x/cluster/intro"},{"@type":"ListItem","position":2,"name":"High Availability","item":"https://bifromq.apache.org/docs/3.1.x/cluster/high_availability"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="An Open Source Apache MQTT Broker | Apache BifroMQ (Incubating) RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="An Open Source Apache MQTT Broker | Apache BifroMQ (Incubating) Atom Feed">








<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.bafcad60.css">
<script src="/assets/js/runtime~main.11263013.js" defer="defer"></script>
<script src="/assets/js/main.6ac611ef.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><link rel="preload" as="image" href="/img/logo_dark.svg"><link rel="preload" as="image" href="/img/apache-incubator.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_JVlP" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Apache BifroMQ" class="bifromq-navbar-logo-class themedComponent_e8Gq themedComponent--light_F3KA" style="height:32px;width:auto"><img src="/img/logo_dark.svg" alt="Apache BifroMQ" class="bifromq-navbar-logo-class themedComponent_e8Gq themedComponent--dark_DJaA" style="height:32px;width:auto"></div><b class="navbar__title text--truncate">BifroMQ</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/3.1.x/get_started/intro/">Documentation</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a class="navbar__item navbar__link" href="/community/">Community</a><a class="navbar__item navbar__link" href="/download/">Downloads</a><a class="navbar__item navbar__link" href="/docs/get_started/faq/">FAQ</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/3.1.x/cluster/high_availability/">3.1.x</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/get_started/intro/">4.0.0-incubating</a></li><li><a class="dropdown__link" href="/docs/3.3.x/cluster/high_availability/">3.3.x</a></li><li><a class="dropdown__link" href="/docs/3.2.x/cluster/high_availability/">3.2.x</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/3.1.x/cluster/high_availability/">3.1.x</a></li><li><a class="dropdown__link" href="/docs/3.0.x/cluster/high_availability/">3.0.x</a></li><li><a class="dropdown__link" href="/docs/2.1.x/Readme/">2.1.x</a></li><li><a class="dropdown__link" href="/docs/2.0.0/Readme/">2.0.0</a></li><li><a class="dropdown__link" href="/docs/1.0.x/Readme/">1.0.x</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Foundation</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Apache Software Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li><li><a href="https://www.apache.org/foundation/policies/conduct.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Code of Conduct</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy Policy</a></li></ul></div><a href="https://github.com/apache/bifromq" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_Q_pE colorModeToggle_hBwJ"><button class="clean-btn toggleButton_X3Tf toggleButtonDisabled_Jfqk" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_E103 lightToggleIcon_vGnc"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_E103 darkToggleIcon_W_zH"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_E103 systemToggleIcon_ut44"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Piy_"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_xD0N"><div class="docsWrapper_rqH3"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_QEPs" type="button"></button><div class="docRoot_B66_"><aside class="theme-doc-sidebar-container docSidebarContainer_dX9I"><div class="sidebarViewport_W9BS"><div class="sidebar_eFmT"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_fyN6"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_d8zQ menu__link menu__link--sublist" href="/docs/3.1.x/get_started/intro/"><span title="Get Started" class="categoryLinkLabel_IwwX">Get Started</span></a><button aria-label="Expand sidebar category &#x27;Get Started&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_d8zQ menu__link menu__link--sublist" href="/docs/3.1.x/installation/intro/"><span title="Installation" class="categoryLinkLabel_IwwX">Installation</span></a><button aria-label="Expand sidebar category &#x27;Installation&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_d8zQ menu__link menu__link--sublist menu__link--active" href="/docs/3.1.x/cluster/intro/"><span title="BifroMQ Cluster" class="categoryLinkLabel_IwwX">BifroMQ Cluster</span></a><button aria-label="Collapse sidebar category &#x27;BifroMQ Cluster&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/3.1.x/cluster/standardcluster/"><span title="Deploy StandardCluster" class="linkLabel_OpeM">Deploy StandardCluster</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/3.1.x/cluster/high_availability/"><span title="High Availability" class="linkLabel_OpeM">High Availability</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_d8zQ menu__link menu__link--sublist" href="/docs/3.1.x/user_guide/intro/"><span title="User Guide" class="categoryLinkLabel_IwwX">User Guide</span></a><button aria-label="Expand sidebar category &#x27;User Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_d8zQ menu__link menu__link--sublist" href="/docs/3.1.x/plugin/intro/"><span title="Plugin" class="categoryLinkLabel_IwwX">Plugin</span></a><button aria-label="Expand sidebar category &#x27;Plugin&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_d8zQ menu__link menu__link--sublist" href="/docs/3.1.x/admin_guide/overview/"><span title="Administration" class="categoryLinkLabel_IwwX">Administration</span></a><button aria-label="Expand sidebar category &#x27;Administration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_d8zQ menu__link menu__link--sublist" href="/docs/3.1.x/mqtt_best_practices/mqtt/"><span title="MQTT Best Practices" class="categoryLinkLabel_IwwX">MQTT Best Practices</span></a><button aria-label="Expand sidebar category &#x27;MQTT Best Practices&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/3.1.x/test_report/report/"><span title="Test Report" class="linkLabel_OpeM">Test Report</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/3.1.x/bifromq_inside/"><span title="BifroMQ Inside" class="linkLabel_OpeM">BifroMQ Inside</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_dB3t"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_Cs1Z"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->An Open Source Apache MQTT Broker | Apache BifroMQ (Incubating)<!-- --> <b>3.1.x</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/get_started/intro/">latest version</a></b> (<!-- -->4.0.0-incubating<!-- -->).</div></div><div class="docItemContainer_Ta0w"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_p1N8" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_fj1P"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/3.1.x/cluster/intro/"><span>BifroMQ Cluster</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">High Availability</span></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 3.1.x</span><div class="tocCollapsible_pG2r theme-doc-toc-mobile tocMobile_btvO"><button type="button" class="clean-btn tocCollapsibleButton_bvh7">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>High Availability</h1></header><p>Due to the decentralized cluster-building capability provided by the Gossip-based protocol (base-cluster) we offer, BifroMQ StandardCluster nodes do not require additional service discovery components to establish a cluster. This eliminates
operational risks associated with single points of failure and enables the flexible scalability of the cluster, ensuring high availability across the entire system.</p>
<p>From an implementation perspective, BifroMQ internally decomposes the workload, forming logically independent subclusters for each type of load. Specifically, modules related to storage leverage the Raft algorithm to guarantee consistency
and high availability.</p>
<h2 class="anchor anchorTargetStickyNavbar_zVyf" id="how-to-enable-high-availability-in-a-cluster">How to Enable High Availability in a Cluster<a href="#how-to-enable-high-availability-in-a-cluster" class="hash-link" aria-label="Direct link to How to Enable High Availability in a Cluster" title="Direct link to How to Enable High Availability in a Cluster" translate="no">​</a></h2>
<p>Currently, the BifroMQ StandardCluster employs a deployment model that encapsulates all workloads within a single process. As different subclusters have varying requirements for high availability, enabling high availability in the BifroMQ
cluster necessitates meeting the following conditions.</p>
<h3 class="anchor anchorTargetStickyNavbar_zVyf" id="cluster-node-count">Cluster Node Count<a href="#cluster-node-count" class="hash-link" aria-label="Direct link to Cluster Node Count" title="Direct link to Cluster Node Count" translate="no">​</a></h3>
<p>For the stateful distributed storage, base-kv, in a cluster, the availability of the service is ensured only if more than half of the nodes in the cluster are alive. Therefore, <strong>the cluster deployment must have a node count greater than or
equal to 3</strong>.</p>
<h3 class="anchor anchorTargetStickyNavbar_zVyf" id="configuration-of-base-cluster">Configuration of base-cluster<a href="#configuration-of-base-cluster" class="hash-link" aria-label="Direct link to Configuration of base-cluster" title="Direct link to Configuration of base-cluster" translate="no">​</a></h3>
<p>The configurations related to base-cluster are centralized in the &quot;clusterConfig&quot; section of the configuration file:</p>
<table><thead><tr><th>Parameter Name</th><th>Default Value</th><th>Recommended Value</th></tr></thead><tbody><tr><td>host</td><td>Null</td><td>Input the IP addresses that are mutually accessible within the cluster.</td></tr><tr><td>ip</td><td>Null</td><td>Input the ports that are mutually accessible within the cluster.</td></tr><tr><td>seedEndpoints</td><td>Not Null</td><td>Entrance for the request of a new node joining the cluster. It is recommended to input the list of endpoints for all nodes in the cluster or a unified proxy address for all nodes.</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_zVyf" id="configuration-of-base-kv-replica-count">Configuration of base-kv Replica Count<a href="#configuration-of-base-kv-replica-count" class="hash-link" aria-label="Direct link to Configuration of base-kv Replica Count" title="Direct link to Configuration of base-kv Replica Count" translate="no">​</a></h3>
<p>BifroMQ&#x27;s internal storage is divided into three parts: MQTT subscription routes, MQTT messages from connections with <code>cleanSession=false</code>, and retained messages. The corresponding module names in BifroMQ are: <code>dist-worker</code> for MQTT
subscription routes, <code>inbox-store</code> for MQTT messages with <code>cleanSession=false</code> connections, and <code>retain-store</code> for retained messages. Each module forms an independent base-kv subcluster.</p>
<p>The configuration for the number of replicas in base-kv is passed through system variables. To achieve high availability, the following system variables need to be modified:</p>
<table><thead><tr><th>System Variable Name</th><th>Default Value</th><th>Recommended Value</th></tr></thead><tbody><tr><td>dist_worker_range_voter_count</td><td>3</td><td>At least 3, preferably an odd number.</td></tr><tr><td>inbox_store_range_voter_count</td><td>1</td><td>At least 3, preferably an odd number.</td></tr><tr><td>retain_store_range_voter_count</td><td>3</td><td>At least 3, preferably an odd number.</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_zVyf" id="impact-of-high-availability">Impact of High Availability<a href="#impact-of-high-availability" class="hash-link" aria-label="Direct link to Impact of High Availability" title="Direct link to Impact of High Availability" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_zVyf" id="throughput-of-messages-with-cleansessionfalse">Throughput of Messages with <code>cleanSession=false</code><a href="#throughput-of-messages-with-cleansessionfalse" class="hash-link" aria-label="Direct link to throughput-of-messages-with-cleansessionfalse" title="Direct link to throughput-of-messages-with-cleansessionfalse" translate="no">​</a></h3>
<p>After enabling multiple replicas in inbox-store, each offline message write operation must wait for the Raft protocol to complete the replication between the Leader and the majority of members before it is considered truly successful.
Additionally, saving a message requires actual execution of the write operation multiple times, depending on the number of replicas. Therefore, the number of replicas will impact the response latency of messages with <code>cleanSession=false</code>
and the overall throughput of the cluster.</p>
<p>During deployment, it is advisable to assess and set a reasonable number of replicas based on the actual usage scenario, striking a balance between high availability and performance.</p>
<h2 class="anchor anchorTargetStickyNavbar_zVyf" id="analysis-of-failure-scenarios-and-recovery">Analysis of Failure Scenarios and Recovery<a href="#analysis-of-failure-scenarios-and-recovery" class="hash-link" aria-label="Direct link to Analysis of Failure Scenarios and Recovery" title="Direct link to Analysis of Failure Scenarios and Recovery" translate="no">​</a></h2>
<p>Taking a three-node deployment of BifroMQ with inbox-store configured for triple replication as an example.</p>
<h3 class="anchor anchorTargetStickyNavbar_zVyf" id="one-node-failure">One Node Failure<a href="#one-node-failure" class="hash-link" aria-label="Direct link to One Node Failure" title="Direct link to One Node Failure" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_zVyf" id="impact">Impact<a href="#impact" class="hash-link" aria-label="Direct link to Impact" title="Direct link to Impact" translate="no">​</a></h4>
<p>According to the Raft protocol, the remaining two replicas can continue to function correctly. If the crashed node is the leader, the remaining two replicas will elect a new leader and continue to operate, ensuring no data loss.</p>
<h4 class="anchor anchorTargetStickyNavbar_zVyf" id="recovery">Recovery<a href="#recovery" class="hash-link" aria-label="Direct link to Recovery" title="Direct link to Recovery" translate="no">​</a></h4>
<p>Restarting the crashed node or starting a new node will be automatically discovered by BifroMQ, and it will be automatically added to the Raft cluster, forming a triple replica to restore high availability.</p>
<h3 class="anchor anchorTargetStickyNavbar_zVyf" id="two-node-failure">Two Node Failure<a href="#two-node-failure" class="hash-link" aria-label="Direct link to Two Node Failure" title="Direct link to Two Node Failure" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_zVyf" id="impact-1">Impact<a href="#impact-1" class="hash-link" aria-label="Direct link to Impact" title="Direct link to Impact" translate="no">​</a></h4>
<p>According to the Raft protocol, the remaining single replica cannot achieve a consensus among more than half of the nodes, and therefore, it cannot operate normally.</p>
<h4 class="anchor anchorTargetStickyNavbar_zVyf" id="recovery-1">Recovery<a href="#recovery-1" class="hash-link" aria-label="Direct link to Recovery" title="Direct link to Recovery" translate="no">​</a></h4>
<ul>
<li class="">When restarting the crashed node, the node will reload the previously persisted replica data. BifroMQ cluster discovers the new node and automatically adds it to the Raft cluster, forming a triple replica to restore high availability,
with no data loss.</li>
<li class="">Starting two new nodes will be automatically discovered by BifroMQ, and it will add them to the Raft cluster automatically, forming a triple replica to restore high availability.
<em><strong>Note: If the remaining nodes after a crash are followers and have not synchronized to the latest progress of the leader, this recovery method may result in the loss of some data that has already achieved Raft consensus and been
written.</strong></em></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_zVyf" id="three-node-failure">Three Node Failure<a href="#three-node-failure" class="hash-link" aria-label="Direct link to Three Node Failure" title="Direct link to Three Node Failure" translate="no">​</a></h3>
<p>Similar to the impact and recovery scenarios with two nodes crashing.</p>
<h3 class="anchor anchorTargetStickyNavbar_zVyf" id="automatic-recovery-capability-optional">Automatic Recovery Capability (Optional)<a href="#automatic-recovery-capability-optional" class="hash-link" aria-label="Direct link to Automatic Recovery Capability (Optional)" title="Direct link to Automatic Recovery Capability (Optional)" translate="no">​</a></h3>
<p>The Raft protocol requires that more than half of the nodes in the cluster must be alive for the system to operate. In the scenario where two nodes crash, as described above, the remaining single replica will be unable to function.</p>
<p>BifroMQ provides a configurable capability that allows the cluster to detect whether it is in a Raft lost majority situation and proactively reduce the Voter list in the Raft configuration, enabling it to continue functioning.</p>
<p>Add the following parameters to the configuration file to override the existing policy:</p>
<div class="language-text codeBlockContainer_bxiR theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_Bf3P"><pre tabindex="0" class="prism-code language-text codeBlock_LScK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_4r6S"><span class="token-line" style="color:#393A34"><span class="token plain">stateStoreConfig:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  inboxStoreConfig:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    balanceConfig:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      balancers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - com.baidu.bifromq.inbox.store.balance.ReplicaCntBalancerFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - com.baidu.bifromq.inbox.store.balance.RangeSplitBalancerFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - com.baidu.bifromq.inbox.store.balance.RangeLeaderBalancerFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - com.baidu.bifromq.inbox.store.balance.RecoveryBalancerFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  distWorkerConfig:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    balanceConfig:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      balancers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - com.baidu.bifromq.dist.worker.balance.ReplicaCntBalancerFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - com.baidu.bifromq.dist.worker.balance.RecoveryBalancerFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  retainStoreConfig:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    balanceConfig:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      balancers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - com.baidu.bifromq.retain.store.balance.ReplicaCntBalancerFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - com.baidu.bifromq.retain.store.balance.RecoveryBalancerFactory</span><br></span></code></pre></div></div>
<p><em><strong>Note: As analyzed in the previous section, if the remaining minority replicas after a crash are followers and have not synchronized to the latest progress of the leader, there will be some data loss after automatic recovery. Before
enabling this feature, an assessment should be conducted to determine whether this type of data loss is acceptable.</strong></em></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_stCL"><a href="https://github.com/apache/bifromq-sites/tree/master/versioned_docs/version-3.1.x/04_cluster/2_high_availability.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_vtS8" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_zoOp"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/3.1.x/cluster/standardcluster/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Deploy StandardCluster</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/3.1.x/user_guide/intro/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">User Guide Overview</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_lswO thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#how-to-enable-high-availability-in-a-cluster" class="table-of-contents__link toc-highlight">How to Enable High Availability in a Cluster</a><ul><li><a href="#cluster-node-count" class="table-of-contents__link toc-highlight">Cluster Node Count</a></li><li><a href="#configuration-of-base-cluster" class="table-of-contents__link toc-highlight">Configuration of base-cluster</a></li><li><a href="#configuration-of-base-kv-replica-count" class="table-of-contents__link toc-highlight">Configuration of base-kv Replica Count</a></li></ul></li><li><a href="#impact-of-high-availability" class="table-of-contents__link toc-highlight">Impact of High Availability</a><ul><li><a href="#throughput-of-messages-with-cleansessionfalse" class="table-of-contents__link toc-highlight">Throughput of Messages with <code>cleanSession=false</code></a></li></ul></li><li><a href="#analysis-of-failure-scenarios-and-recovery" class="table-of-contents__link toc-highlight">Analysis of Failure Scenarios and Recovery</a><ul><li><a href="#one-node-failure" class="table-of-contents__link toc-highlight">One Node Failure</a></li><li><a href="#two-node-failure" class="table-of-contents__link toc-highlight">Two Node Failure</a></li><li><a href="#three-node-failure" class="table-of-contents__link toc-highlight">Three Node Failure</a></li><li><a href="#automatic-recovery-capability-optional" class="table-of-contents__link toc-highlight">Automatic Recovery Capability (Optional)</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Apache BifroMQ</div><ul class="footer__items clean-list"><li class="footer__item">
                <div style="margin-bottom: 1.5rem;">
                  <p style="font-size: 0.9rem; line-height: 1.6; color: var(--color-text-secondary); max-width: 320px; margin-bottom: 2rem;">
                    High-performance Apache MQTT broker with enterprise-grade reliability. Applicable to IoT, IM and other scenarios.
                  </p>
                  <div style="display: flex; gap: 24px; align-items: center;">
                    <a href="https://github.com/apache/bifromq" target="_blank" rel="noopener noreferrer" style="color: var(--color-text-tertiary); transition: color 0.3s; display: flex;" onmouseover='this.style.color="var(--bifrost-blue)"' onmouseout='this.style.color="var(--color-text-tertiary)"'>
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                    </a>
                    <a href="https://discord.gg/Pfs3QRadRB" target="_blank" rel="noopener noreferrer" style="color: var(--color-text-tertiary); transition: color 0.3s; display: flex;" onmouseover='this.style.color="var(--bifrost-blue)"' onmouseout='this.style.color="var(--color-text-tertiary)"'>
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.419c0 1.334-.956 2.419-2.157 2.419zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.419c0 1.334-.946 2.419-2.157 2.419z"/></svg>
                    </a>
                    <a href="mailto:dev@bifromq.apache.org" style="color: var(--color-text-tertiary); transition: color 0.3s; display: flex;" onmouseover='this.style.color="var(--bifrost-blue)"' onmouseout='this.style.color="var(--color-text-tertiary)"'>
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    </a>
                  </div>
                </div>
              </li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/apache/bifromq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awll"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/apache/bifromq/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item">Releases<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awll"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/apache/bifromq/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issues<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awll"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Apache</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Apache Incubator<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awll"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/policies/conduct.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code of Conduct<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awll"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="noopener noreferrer" class="footer__link-item">Apache 2.0 License<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awll"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Others</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.baidu.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Thanks OpenSource@Baidu<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awll"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">MQTT v3.1.1<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awll"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">MQTT v5.0<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awll"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" rel="noopener noreferrer" class="footerLogoLink_N2RY"><img src="/img/apache-incubator.svg" alt="Apache Incubator" class="footer__logo footer__incubator-logo themedComponent_e8Gq themedComponent--light_F3KA" width="180"><img src="/img/apache-incubator.svg" alt="Apache Incubator" class="footer__logo footer__incubator-logo themedComponent_e8Gq themedComponent--dark_DJaA" width="180"></a></div><div class="footer__copyright">
        <div style="font-size: 0.8rem; line-height: 1.8; color: var(--color-text-tertiary); text-align: center; border-top: 1px solid var(--color-border); padding-top: 3rem;">
          <p style="margin-bottom: 1.5rem; max-width: 1100px; margin-left: auto; margin-right: auto;">
            Apache BifroMQ is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
          </p>
          <p style="margin-bottom: 1.5rem;">
            Copyright © 2026 The Apache Software Foundation, Licensed under the Apache License, Version 2.0.
          </p>
          <p style="max-width: 1200px; margin-left: auto; margin-right: auto;">
            Apache, the names of Apache projects, and the feather logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries.
          </p>
        </div>
      </div></div></div></footer></div>
</body>
</html>