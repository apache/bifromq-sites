<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">BifroMQ: Unveiling the Technology for Building Efficient and Available Clusters | Apache BifroMQ (Incubating) - Open source MQTT Broker</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://bifromq.apache.org/blog/bifromq-high-availibility/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="BifroMQ: Unveiling the Technology for Building Efficient and Available Clusters | Apache BifroMQ (Incubating) - Open source MQTT Broker"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-12-01T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/popduke,https://github.com/mafei6827"><meta data-rh="true" property="article:tag" content="BifroMQ,Open Source,MQTT,High Availability,Technical Architecture,Cluster,Distributed Key-Value,Load Balancing"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://bifromq.apache.org/blog/bifromq-high-availibility/"><link data-rh="true" rel="alternate" href="https://bifromq.apache.org/blog/bifromq-high-availibility/" hreflang="en"><link data-rh="true" rel="alternate" href="https://bifromq.apache.org/blog/bifromq-high-availibility/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://bifromq.apache.org/blog/bifromq-high-availibility","mainEntityOfPage":"https://bifromq.apache.org/blog/bifromq-high-availibility","url":"https://bifromq.apache.org/blog/bifromq-high-availibility","headline":"BifroMQ: Unveiling the Technology for Building Efficient and Available Clusters","name":"BifroMQ: Unveiling the Technology for Building Efficient and Available Clusters","description":"Introduction","datePublished":"2023-12-01T00:00:00.000Z","author":[{"@type":"Person","name":"Yonny(Yu) Hao","url":"https://github.com/popduke","image":"https://github.com/popduke.png"},{"@type":"Person","name":"Ma Fei","url":"https://github.com/mafei6827","image":"https://github.com/mafei6827.png"}],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://bifromq.apache.org/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache BifroMQ (Incubating) - Open source MQTT Broker RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache BifroMQ (Incubating) - Open source MQTT Broker Atom Feed"><link rel="stylesheet" href="/assets/css/styles.9f1b226c.css">
<script src="/assets/js/runtime~main.2b2717cc.js" defer="defer"></script>
<script src="/assets/js/main.adac491d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><link rel="preload" as="image" href="/img/logo_dark.svg"><link rel="preload" as="image" href="https://github.com/popduke.png"><link rel="preload" as="image" href="https://github.com/mafei6827.png"><link rel="preload" as="image" href="/assets/images/BifroMQ-Join-89f00b653137eda40286da4af4966c43.png"><link rel="preload" as="image" href="/assets/images/BifroMQ-Domain-eadf58d82f0156523aa00bccf5b9fb8f.png"><link rel="preload" as="image" href="/assets/images/BifroMQ-AutoEviction-df152e81b44298c21560fc8265bfdd43.png"><link rel="preload" as="image" href="/assets/images/BifroMQ-BrainSplit-a3efa4484066c108c057d395ec79d4d7.png"><link rel="preload" as="image" href="/assets/images/BifroMQ-RPCCluster-f1975e9fac5a8df7f2402be543c94b11.png"><link rel="preload" as="image" href="/assets/images/BifroMQ-RangeBalancer-e0cf651db5d28a2569c4ae14521e4bef.png"><link rel="preload" as="image" href="/assets/images/BifroMQ-ReplicaCntBalancer-0a5150dfe137b5300fb064cb87d2cac5.png"><link rel="preload" as="image" href="/assets/images/BifroMQ-RangeSplitBalancer-546499e878c32ae81bedc224f066a6dc.png"><link rel="preload" as="image" href="/assets/images/BifroMQ-RangeLeaderBalancer-7c95f1d02be4d27dee70a986c25ffc18.png"><link rel="preload" as="image" href="/assets/images/BifroMQ-RecoveryBalancer-7cdc3a95062142846a55f60eb0ae7d45.png"><link rel="preload" as="image" href="/assets/images/BifroMQ-IndependentWorkload-3bcfd6d7b7b46db265d87db47d521be8.png"><link rel="preload" as="image" href="/img/apache-incubator.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_cCsT" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="BifroMQ Logo" class="bifromq-navbar-logo-class themedComponent_kh6W themedComponent--light_h03h"><img src="/img/logo_dark.svg" alt="BifroMQ Logo" class="bifromq-navbar-logo-class themedComponent_kh6W themedComponent--dark_QNPN"></div><b class="navbar__title text--truncate">Apache BifroMQ (Incubating)</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/get_started/intro/">Docs</a><a class="navbar__item navbar__link" href="/community/">Community</a><a class="navbar__item navbar__link" href="/docs/get_started/download/intro/">Download</a><a class="navbar__item navbar__link" href="/docs/get_started/faq/">FAQ</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/get_started/intro/">Next (Incubating)</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/get_started/intro/">Next (Incubating)</a></li><li><a class="dropdown__link" href="/docs/3.3.x/get_started/intro/">3.3.x</a></li><li><a class="dropdown__link" href="/docs/3.2.x/get_started/intro/">3.2.x</a></li><li><a class="dropdown__link" href="/docs/3.1.x/get_started/intro/">3.1.x</a></li><li><a class="dropdown__link" href="/docs/3.0.x/get_started/intro/">3.0.x</a></li><li><a class="dropdown__link" href="/docs/2.1.x/Readme/">2.1.x</a></li><li><a class="dropdown__link" href="/docs/2.0.0/Readme/">2.0.0</a></li><li><a class="dropdown__link" href="/docs/1.0.x/Readme/">1.0.x</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li><li><a href="https://www.apache.org/foundation/policies/conduct.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Code of Conduct</a></li></ul></div><a href="https://github.com/apache/bifromq" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_mVhP colorModeToggle_uW4C"><button class="clean-btn toggleButton_IMMl toggleButtonDisabled_LuC_" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_X8N1 lightToggleIcon_AJW3"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_X8N1 darkToggleIcon_JatO"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_X8N1 systemToggleIcon__uuk"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_AGV4"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_tdfK"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_dtOB thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_QI0f margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_JaZ8">2024</h3><ul class="sidebarItemList_sf3w clean-list"><li class="sidebarItem_MlaL"><a class="sidebarItemLink_PdtZ" href="/blog/bifromq-version-3/">BifroMQ 3.0.0 Beta: Enhanced Messaging with MQTT 5.0</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_JaZ8">2023</h3><ul class="sidebarItemList_sf3w clean-list"><li class="sidebarItem_MlaL"><a class="sidebarItemLink_PdtZ" href="/blog/bifromq-topic-subscription/">BifroMQ&#x27;s Topic Subscription Mechanism</a></li><li class="sidebarItem_MlaL"><a aria-current="page" class="sidebarItemLink_PdtZ sidebarItemLinkActive_J7Co" href="/blog/bifromq-high-availibility/">BifroMQ: Unveiling the Technology for Building Efficient and Available Clusters</a></li><li class="sidebarItem_MlaL"><a class="sidebarItemLink_PdtZ" href="/blog/bifromq-standardcluster/">BifroMQ StandardCluster</a></li><li class="sidebarItem_MlaL"><a class="sidebarItemLink_PdtZ" href="/blog/bifromq-tech-architecture/">BifroMQ Technical Architecture Overview</a></li><li class="sidebarItem_MlaL"><a class="sidebarItemLink_PdtZ" href="/blog/AnyAuth and Integration with BifroMQ/">AnyAuth and Integration with BifroMQ</a></li><li class="sidebarItem_MlaL"><a class="sidebarItemLink_PdtZ" href="/blog/news-bifromq-opensource/">BifroMQ officially open source : high-performance multi-tenant MQTT Broker</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_LGXf">BifroMQ: Unveiling the Technology for Building Efficient and Available Clusters</h1><div class="container_o_qj margin-vert--md"><time datetime="2023-12-01T00:00:00.000Z">December 1, 2023</time> · <!-- -->15 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_nbqI"><div class="avatar margin-bottom--sm"><a href="https://github.com/popduke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_QuNx" src="https://github.com/popduke.png" alt="Yonny(Yu) Hao"></a><div class="avatar__intro authorDetails_zi_r"><div class="avatar__name"><a href="https://github.com/popduke" target="_blank" rel="noopener noreferrer"><span class="authorName_J_rd">Yonny(Yu) Hao</span></a></div><div class="authorSocials_ZMMT"></div></div></div></div><div class="col col--6 authorCol_nbqI"><div class="avatar margin-bottom--sm"><a href="https://github.com/mafei6827" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_QuNx" src="https://github.com/mafei6827.png" alt="Ma Fei"></a><div class="avatar__intro authorDetails_zi_r"><div class="avatar__name"><a href="https://github.com/mafei6827" target="_blank" rel="noopener noreferrer"><span class="authorName_J_rd">Ma Fei</span></a></div><div class="authorSocials_ZMMT"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><h2 class="anchor anchorWithStickyNavbar_u6yr" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>The cluster version of BifroMQ has been launched in the community lately, meeting the core demands of users for horizontal scaling and high availability in cluster deployment. We have previously detailed the capabilities of <a href="/blog/bifromq-standardcluster/">BifroMQ StandardCluster</a> in terms of performance scaling. In this article, we will focus on a deep analysis of the technical features adopted by BifroMQ to ensure high availability.</p>
<h2 class="anchor anchorWithStickyNavbar_u6yr" id="decentralized-clusters">Decentralized Clusters<a href="#decentralized-clusters" class="hash-link" aria-label="Direct link to Decentralized Clusters" title="Direct link to Decentralized Clusters">​</a></h2>
<p>In the architecture of BifroMQ, we have meticulously designed a scheme for partitioning the MQTT protocol workload. This strategy allows each type of workload to operate in its own independent sub-cluster. These functional sub-clusters are all built upon a sophisticated decentralized base-cluster framework. The cluster framework of BifroMQ consists of two logical layers: the Underlay Cluster and the Overlay Cluster. Such a construction makes the architecture clear and decoupled. For more details about this design, please refer to the <a href="/blog/bifromq-tech-architecture/">&#x27;BifroMQ Technical Architecture Overview&#x27;</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_u6yr" id="underlay-cluster">Underlay Cluster<a href="#underlay-cluster" class="hash-link" aria-label="Direct link to Underlay Cluster" title="Direct link to Underlay Cluster">​</a></h3>
<p>The Underlay Cluster is the core of the BifroMQ cluster system, with its members representing a running BifroMQ process, and members can communicate directly using the host network address bound to the process. We adopt a Gossip-based Membership protocol (SWIM Protocol) for cluster member failure detection, and have further optimized the synchronization mechanism for Membership information, providing the following technical characteristics:</p>
<ul>
<li>Cluster construction does not depend on traditional registration centers or naming services, effectively eliminating the operational risks of single points of failure, significantly enhancing the cluster&#x27;s high availability.</li>
<li>Using the SWIM protocol, the Underlay Cluster ensures the accuracy of node probing mechanisms between nodes, maintaining the final consistency of the cluster topology.</li>
<li>Using CRDT technology to synchronize Membership information between nodes, achieving extremely low bandwidth usage and timely synchronization.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_u6yr" id="cluster-construction-process">Cluster Construction Process<a href="#cluster-construction-process" class="hash-link" aria-label="Direct link to Cluster Construction Process" title="Direct link to Cluster Construction Process">​</a></h4>
<p>In a decentralized cluster architecture, each cluster member has an equal status, with no special node designated to manage cluster topology information. From a higher perspective, any node running the BifroMQ StandardCluster service process can be seen as an independent cluster with a &quot;single node.&quot; Thus, the construction of the cluster is essentially the fusion of these independent clusters. To facilitate this process, the base-cluster framework provides a &quot;join&quot; operation for the effective merging of these independent clusters.</p>
<img src="/assets/images/BifroMQ-Join-89f00b653137eda40286da4af4966c43.png" style="width:700px">
<p>As shown in the illustration above, the join operation of a cluster can be initiated by any node to any node in the target cluster. For simplicity, we refer to the nodes targeted in the join operation as &quot;seeds.&quot; In a typical deployment process, the addresses of these seed nodes are usually configured in the <a href="/docs/admin_guide/configuration/config_file_manual/">configuration file</a> (seedEndpoints) of the new nodes joining the cluster. After the successful merging of the clusters, each node in the BifroMQ cluster can obtain complete cluster Membership information locally.</p>
<p>Attentive readers may have noticed that directly specifying seed addresses in node configuration may have certain limitations in a containerized environment. To address this issue, the base-cluster framework has built-in DNS resolution functionality. In container environments, we can simplify the cluster deployment process by including all nodes in a fixed network Domain (such as External DNS or Kubernetes Service). Thus, new nodes can use any Remote address resolved from this Domain as the seed to complete the join process.</p>
<img src="/assets/images/BifroMQ-Domain-eadf58d82f0156523aa00bccf5b9fb8f.png" style="width:700px">
<h4 class="anchor anchorWithStickyNavbar_u6yr" id="failuredetection-and-auto-eviction">FailureDetection and Auto-Eviction<a href="#failuredetection-and-auto-eviction" class="hash-link" aria-label="Direct link to FailureDetection and Auto-Eviction" title="Direct link to FailureDetection and Auto-Eviction">​</a></h4>
<p>In BifroMQ, when a node exits normally, it actively clears its registered identity in the cluster and synchronizes this change with other nodes in the cluster. Additionally, each node continuously performs failure detection of other nodes. Once anomalies are detected, the node immediately removes the relevant information of that node from its local cluster Membership and quickly completes the synchronization of Membership information across the cluster, preventing these inactive nodes from affecting the normal function of the cluster.</p>
<img src="/assets/images/BifroMQ-AutoEviction-df152e81b44298c21560fc8265bfdd43.png" style="width:500px">
<p>In conjunction with the automatic eviction mechanism, BifroMQ also has a built-in self-healing mechanism which effectively prevents the erroneous removal of registration information of healthy nodes due to network jitters or misjudgments: each node re-examines its registration information when it observes changes in cluster information. If missing information(about itself) is found, the node will actively supplement it, thus ensuring the integrity and final consistency of cluster information.</p>
<h4 class="anchor anchorWithStickyNavbar_u6yr" id="recovery-from-split-brain">Recovery from Split-Brain<a href="#recovery-from-split-brain" class="hash-link" aria-label="Direct link to Recovery from Split-Brain" title="Direct link to Recovery from Split-Brain">​</a></h4>
<p>For decentralized cluster services, network partition-induced brain splits, where a single cluster divides into multiple isolated clusters, are an unavoidable issue.</p>
<p>The base-cluster ensures protection against potential brain split failures, further enhancing the high availability of cluster deployment. Here&#x27;s how it works: When a network partition happens, the isolated cluster segments detect node failures in the other segments. These failed nodes get added to a &#x27;healing list&#x27; in their respective segments. The system periodically tries to rejoin these nodes from the list until the time exceeds the MTTR(Mean Time To Repair) set during deployment. Notably, this recovery process from brain splits follows a similar pattern to the initial cluster construction.</p>
<img src="/assets/images/BifroMQ-BrainSplit-a3efa4484066c108c057d395ec79d4d7.png" style="width:500px">
<h3 class="anchor anchorWithStickyNavbar_u6yr" id="overlay-cluster">Overlay Cluster<a href="#overlay-cluster" class="hash-link" aria-label="Direct link to Overlay Cluster" title="Direct link to Overlay Cluster">​</a></h3>
<p>The Overlay Cluster, also known as the Agent Cluster, is built on top of the Underlay Cluster. It utilizes the capabilities of the Underlay Cluster for Membership management and inter-member communication, primarily serving as the cluster for specific functional services. Thanks to the efficient construction mechanism of the Underlay Cluster, the Agent Cluster can automatically form the cluster, significantly simplifying the deployment and operational processes.</p>
<p>In BifroMQ, the functional service clusters implemented by the Agent Cluster can be classified into two categories: stateless clusters mainly comprising RPC services, and stateful clusters typically built on the embedded distributed KV storage engine(base-kv).</p>
<h4 class="anchor anchorWithStickyNavbar_u6yr" id="rpc-service-cluster">RPC Service Cluster<a href="#rpc-service-cluster" class="hash-link" aria-label="Direct link to RPC Service Cluster" title="Direct link to RPC Service Cluster">​</a></h4>
<p>Members of the RPC service cluster are usually defined as client and server roles. With the features of the Agent Cluster, the client and server of the RPC do not depend on external registration centers, enabling efficient server discovery and flexible client request routing logic.</p>
<img src="/assets/images/BifroMQ-RPCCluster-f1975e9fac5a8df7f2402be543c94b11.png" style="width:700px">
<h4 class="anchor anchorWithStickyNavbar_u6yr" id="stateful-service-cluster-and-distributed-kv-storage-engine">Stateful Service Cluster and Distributed KV Storage Engine<a href="#stateful-service-cluster-and-distributed-kv-storage-engine" class="hash-link" aria-label="Direct link to Stateful Service Cluster and Distributed KV Storage Engine" title="Direct link to Stateful Service Cluster and Distributed KV Storage Engine">​</a></h4>
<p>BifroMQ&#x27;s stateful service cluster is built on top of the strong consistency distributed KV storage engine--base-kv. This engine features sharding capabilities based on Multi-Raft, making it a key component of BifroMQ&#x27;s high reliability. The Membership information of the cluster is maintained by the Agent Cluster, while each Range shard within the cluster achieves strong consistency synchronization through the Raft protocol. Therefore, to ensure the high reliability of stateful services, it is essential to fully utilize and comply with the characteristics of the Raft protocol.</p>
<h5 class="anchor anchorWithStickyNavbar_u6yr" id="kvrange-balancer">KVRange Balancer<a href="#kvrange-balancer" class="hash-link" aria-label="Direct link to KVRange Balancer" title="Direct link to KVRange Balancer">​</a></h5>
<p>The base-kv uses a built-in Range Balancer framework for efficient management of Range replicas. This framework takes into account the current cluster topology and various real-time load information to generate commands for balancing the Range replica set. These commands include LeaderTransfer, MemberConfigurationChange, RangeSplit, and RangeMerge. Through this series of operations, base-kv can effectively balance the cluster load, optimize throughput, and achieve the goal of high availability.
It is worth mentioning that the Range Balancer also adopts a decentralized design principle. In each node of base-kv, the Balancer is only responsible for managing the local Leader Range. This design allows Balancers on multiple nodes to operate in parallel, ultimately achieving a globally consistent balancing goal.</p>
<img src="/assets/images/BifroMQ-RangeBalancer-e0cf651db5d28a2569c4ae14521e4bef.png" style="width:600px">
<p>BifroMQ has pre-built a range of common load balancing strategies for out-of-box usage. However, for advanced users with specific needs, BifroMQ also offers the capability to customize load balancing strategies (via Balancer SPI), allowing for optimization according to specific application workload scenarios. Below is a brief introduction to the built-in open-source balancers. Users can activate these strategies as needed through configuration.</p>
<p><strong>ReplicaCntBalancer</strong></p>
<p>The primary function of the ReplicaCntBalancer is to adjust and balance the number of replicas of a Range within a cluster deployment. Once enabled, this feature allows the number of Range replicas to be flexibly adjusted according to the number of deployment nodes in the BifroMQ StandardCluster cluster. This means that the ReplicaCntBalancer can automatically optimize and achieve the best availability configuration according to the current scale of the cluster, to reduce the cluster operation work.</p>
<img src="/assets/images/BifroMQ-ReplicaCntBalancer-0a5150dfe137b5300fb064cb87d2cac5.png" style="width:700px">
<p>As shown above, the working process is as follows:</p>
<ul>
<li>Cluster scale-up: Suppose initially there are 3 nodes in the BifroMQ cluster, and the number of Range replicas is also 3, allowing the cluster to tolerate the failure of 1 node. When 2 more nodes are added to the cluster, the ReplicaCntBalancer automatically incorporates these new nodes into the replica configuration, and after data synchronization, the number of replicas increases to 5. This allows the cluster to tolerate the unavailability of 2 nodes, thus enhancing the cluster&#x27;s fault tolerance.</li>
<li>Cluster scale-down: In another scenario, when the BifroMQ cluster contains 5 nodes and the number of Range replicas is also 5, if two nodes crash, the cluster can still operate normally according to the Raft algorithm. However, if the replica configuration remains unchanged, another node&#x27;s crash will cause the entire Raft cluster to become inoperable. At this point, the ReplicaCntBalancer will adjust the replica configuration to include only the remaining 3 available nodes. This adjustment ensures that the cluster remains highly available even if one more node becomes unavailable.</li>
</ul>
<p><strong>RangeSplitBalancer</strong></p>
<p>In BifroMQ, each Range&#x27;s replica set is managed through the Raft protocol, and its load capacity is limited by the WAL replication mechanism, thus having a certain performance ceiling. Especially when application workloads are highly concentrated on a single Range, this limitation becomes particularly apparent. In such cases, splitting a Range into multiple parts is an effective way to enhance the system&#x27;s parallel task handling capability, thereby improving the overall system performance.</p>
<p>The RangeSplitBalancer is the built-in load balancing strategy in base-kv that implements this functionality. It analyzes the actual application workload and timely generates Range splitting instructions, thereby optimizing system processing capacity and enhancing performance.</p>
<img src="/assets/images/BifroMQ-RangeSplitBalancer-546499e878c32ae81bedc224f066a6dc.png" style="width:600px">
<p><strong>RangeLeaderBalancer</strong></p>
<p>In the Raft protocol, the Leader node handles all write requests and some read requests. Therefore, when the Leader replicas of multiple Ranges are concentrated on the same node, it can easily create load hotspots, affecting system performance. To address this issue, the base-kv cluster can activate the RangeLeaderBalancer in situations where multiple Ranges are splitting.</p>
<p>The RangeLeaderBalancer is specifically responsible for monitoring and adjusting the distribution of Range leader replicas across nodes. It achieves balance by migrating Ranges between nodes, ensuring an even distribution of Leader replicas on each base-kv node.</p>
<img src="/assets/images/BifroMQ-RangeLeaderBalancer-7c95f1d02be4d27dee70a986c25ffc18.png" style="width:600px">
<p><strong>RecoveryBalancer</strong></p>
<p>In non-Byzantine fault-tolerant strong consistency protocols, the number of functioning nodes n must satisfy the condition n ≥ 2f+1, where f represents the number of fail-tolerant nodes. Based on this principle, any Range replica must be located in more than half of the normal cluster nodes to ensure proper operation. However, in actual deployment, when there are many Ranges in the cluster and a single base-kv node may carry replicas of multiple different Ranges, simultaneous failures of multiple cluster nodes could lead to a situation where n &lt; 2f+1, known as Lost Majority. In the event of Lost Majority, the affected Ranges will be unable to operate normally.</p>
<p>To deal with this situation, the RecoveryBalancer provides a opt-in capability. It allows nodes to detect if they are in a Lost Majority state and, if necessary, actively reduce the replica list configuration to ensure that at least half of the nodes are alive, thus enabling the Range to continue functioning. However, it is important to note that the recovery process is beyond the scope of Raft protocol when using RecoveryBalancer to automatically recover Ranges in a Lost Majority state, if the originally failed nodes rejoin the cluster without manual intervention, it may lead to data loss and inconsistency issues. In such cases, users need to carefully consider and combine actual operational strategies to decide whether to enable the RecoveryBalancer in their deployment.</p>
<img src="/assets/images/BifroMQ-RecoveryBalancer-7cdc3a95062142846a55f60eb0ae7d45.png" style="width:700px">
<h3 class="anchor anchorWithStickyNavbar_u6yr" id="stateful-functional-services">Stateful Functional Services<a href="#stateful-functional-services" class="hash-link" aria-label="Direct link to Stateful Functional Services" title="Direct link to Stateful Functional Services">​</a></h3>
<p>BifroMQ&#x27;s stateful sub-services come in three types: MQTT subscription routing, offline message queues, and retain message storage. These are implemented by corresponding modules: dist-worker, inbox-store, and retain-store, respectively. Each module, once deployed, forms an independent base-kv cluster.</p>
<p>To adapt to various workload demands, BifroMQ allows each independent cluster to select and initiate suitable Balancer strategies based on its specific conditions. This flexible configuration of strategies ensures that each cluster maintains high availability while achieving optimal data processing and throughput performance.</p>
<h4 class="anchor anchorWithStickyNavbar_u6yr" id="dist-worker">dist-worker<a href="#dist-worker" class="hash-link" aria-label="Direct link to dist-worker" title="Direct link to dist-worker">​</a></h4>
<p>In BifroMQ&#x27;s architecture, the dist-worker module is responsible for managing subscription information (Sub) and message distribution (Pub). In normal use cases, this is typically a scenario dominated by read operations with fewer write operations.</p>
<p>Considering this workload pattern, the dist-worker adopts the following default Balancer strategies:</p>
<ul>
<li>Enabling dynamic replica count: This strategy ensures that the number of KVRange replicas is consistent with the number of cluster nodes, maximizing query throughput efficiency.</li>
<li>Limiting voter replica count: While ensuring high availability, the number of Raft Voters is limited to a maximum of three. Other replicas serve as Learners, reducing the response latency of write operations.</li>
</ul>
<p>In most common use cases, the number of subscribers that a Publish message matches is usually not large, and the matching process is relatively fast. Given this, the dist-worker module does not activate the Range splitting strategy in its default configuration.</p>
<p>However, in scenarios where messages require large-scale Fanout, especially when low latency is also a requirement, the query efficiency of a single Range could become a bottleneck for overall performance. To address these challenges, we plan to enhance this aspect of processing capability in future versions of BifroMQ to optimize performance in handling message fanout to large scale subscribers.</p>
<h4 class="anchor anchorWithStickyNavbar_u6yr" id="retain-store">retain-store<a href="#retain-store" class="hash-link" aria-label="Direct link to retain-store" title="Direct link to retain-store">​</a></h4>
<p>Normally retain-store has similar workload characteristic as dist-worker, so the default Balancer strategy same and will not be reiterated here.</p>
<h4 class="anchor anchorWithStickyNavbar_u6yr" id="inbox-store">inbox-store<a href="#inbox-store" class="hash-link" aria-label="Direct link to inbox-store" title="Direct link to inbox-store">​</a></h4>
<p>In BifroMQ, the inbox-store module takes on the role of managing offline messages for each connection with cleanSession=false. For these connections, inbox-store creates a dedicated persistent offline message queue. Subscribed messages are first written into this queue. When the connection goes back online, messages are pulled from the queue for delivery and subsequently deleted. This is a typical scenario with frequent read and write, where the workload is mainly concentrated on the Leader replica, and the IO latency of storage significantly impacts system message throughput.</p>
<p>Considering this kind of workload pattern, the default Balancer strategies for the inbox-store are as follows:</p>
<ul>
<li>Limiting the Voter to 1 by default: As a higher number of replicas can lead to increased write response latency, the default setting limits the number of Range replicas to 1. This prioritizes rapid message processing but comes with some reliability trade-offs. Users can adjust the number of replicas based on their needs.</li>
<li>Enabling range split and leader balancing: This strategy allows the inbox-store to dynamically shard and expand as the workload gradually increases, ultimately achieving a more balanced load distribution.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_u6yr" id="notes-on-bifromq-standardcluster-deployment">Notes on BifroMQ StandardCluster Deployment<a href="#notes-on-bifromq-standardcluster-deployment" class="hash-link" aria-label="Direct link to Notes on BifroMQ StandardCluster Deployment" title="Direct link to Notes on BifroMQ StandardCluster Deployment">​</a></h2>
<p>BifroMQ StandardCluster adopts a deployment strategy that integrates all functional modules into a single process. This strategy simplifies the configuration and deployment process, similar to the &#x27;SharedNothing&#x27; cluster architecture commonly used in the industry. However, because multiple modules share the same system resources allocated for one process, this limits the ability to &quot;fine-tune&quot; the allocation based on actual application needs. All modules need to be scaled up or down uniformly, which may not be suitable for cloud scenarios, where different types of workload fluctuations are time-related and require more detailed and flexible resource management.</p>
<h2 class="anchor anchorWithStickyNavbar_u6yr" id="from-bifromq-standardcluster-to-independentworkload-cluster">From BifroMQ StandardCluster To IndependentWorkload Cluster<a href="#from-bifromq-standardcluster-to-independentworkload-cluster" class="hash-link" aria-label="Direct link to From BifroMQ StandardCluster To IndependentWorkload Cluster" title="Direct link to From BifroMQ StandardCluster To IndependentWorkload Cluster">​</a></h2>
<p>The unique architectural design of BifroMQ enables it to easily implement a deployment mode of &#x27;independent process per module&#x27;, which we call the IndependentWorkload Cluster (to be introduced in future versions). This mode not only offers greater flexibility and more precise resource management capabilities, but it also helps users to gradually transition from the StandardCluster mode to the IndependentWorkload Cluster mode in line with the development of business. Such a progressive deployment change can optimize resource allocation and respond to fluctuations in business demands while maintaining business continuity.</p>
<img src="/assets/images/BifroMQ-IndependentWorkload-3bcfd6d7b7b46db265d87db47d521be8.png" style="width:700px">
<h2 class="anchor anchorWithStickyNavbar_u6yr" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>The above content provides a comprehensive introduction to the high-availability technology of BifroMQ. BifroMQ ensures the overall high availability of its clusters through the implementation of various mechanisms. Please look forward to a series of upcoming specialized articles where we will delve deeper into the various components of BifroMQ and their design principles, offering you more in-depth technical insights.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_kw4g padding--none margin-left--sm"><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/bifro-mq/">BifroMQ</a></li><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/open-source/">Open Source</a></li><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/mqtt/">MQTT</a></li><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/high-availability/">High Availability</a></li><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/technical-architecture/">Technical Architecture</a></li><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/cluster/">Cluster</a></li><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/distributed-key-value/">Distributed Key-Value</a></li><li class="tag_dR3I"><a rel="tag" class="tag_aqcr tagRegular_CD38" href="/blog/tags/load-balancing/">Load Balancing</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/apache/bifromq-sites/tree/master/blog" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_s6_v" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_SVwk"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/bifromq-topic-subscription/"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">BifroMQ&#x27;s Topic Subscription Mechanism</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/bifromq-standardcluster/"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">BifroMQ StandardCluster</div></a></nav></main><div class="col col--2"><div class="tableOfContents_D50z thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#decentralized-clusters" class="table-of-contents__link toc-highlight">Decentralized Clusters</a><ul><li><a href="#underlay-cluster" class="table-of-contents__link toc-highlight">Underlay Cluster</a></li><li><a href="#overlay-cluster" class="table-of-contents__link toc-highlight">Overlay Cluster</a></li><li><a href="#stateful-functional-services" class="table-of-contents__link toc-highlight">Stateful Functional Services</a></li></ul></li><li><a href="#notes-on-bifromq-standardcluster-deployment" class="table-of-contents__link toc-highlight">Notes on BifroMQ StandardCluster Deployment</a></li><li><a href="#from-bifromq-standardcluster-to-independentworkload-cluster" class="table-of-contents__link toc-highlight">From BifroMQ StandardCluster To IndependentWorkload Cluster</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" rel="noopener noreferrer" class="footerLogoLink_U0bA"><img src="/img/apache-incubator.svg" alt="Apache Incubator logo" class="footer__logo themedComponent_kh6W themedComponent--light_h03h" width="200"><img src="/img/apache-incubator.svg" alt="Apache Incubator logo" class="footer__logo themedComponent_kh6W themedComponent--dark_QNPN" width="200"></a></div><div class="footer__copyright"><div>
      <p>
        Apache BifroMQ is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
      </p>
      <p>
        Copyright © 2025 The Apache Software Foundation, Licensed under the Apache License, Version 2.0. <br>
        Apache, the names of Apache projects, and the feather logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries.
      </p>
      </div></div></div></div></footer></div>
</body>
</html>